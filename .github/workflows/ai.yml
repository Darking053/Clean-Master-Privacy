name: Rust Auto-Pilot

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  fix-and-close:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Kodu ek
        uses: actions/checkout@v4

      # HATA BURADAYDI: Gerekli sistem k羹t羹phanelerini y羹kl羹yoruz
      - name: Sistem Ba覺ml覺l覺klar覺n覺 Kur (GObject & GTK)
        run: |
          sudo apt-get update
          sudo apt-get install -y libglib2.0-dev libgtk-3-dev build-essential pkg-config

      - name: Rust Kurulumu
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      # KODU OTOMAT襤K DZELT
      - name: Hatalar覺 Temizle (Clippy & Fmt)
        run: |
          cargo fmt --all
          # Hatalar覺 d羹zeltmeye 癟al覺覺rken ba覺ml覺l覺klar覺 da kontrol eder
          cargo clippy --fix --allow-dirty --allow-staged

      # DE襤襤KL襤KLER襤 PUSHLA
      - name: Otomatik Commit
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI: Rust ba覺ml覺l覺klar覺 癟繹z羹ld羹 ve kod d羹zeltildi (Fixes #)"

      # ISSUES'LARI ANAL襤Z ET VE KAPAT
      - name: Sorunlar覺 Kapat
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const issue of issues.data) {
              // Bal覺kta 'fix' ge癟iyorsa veya 22 a癟覺k issue olduu i癟in hepsini temizlemek istersen:
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                body: ' Sistem ba覺ml覺l覺klar覺 giderildi ve kod baar覺yla derlendi. Bu sorun AI taraf覺ndan otomatik olarak kapat覺ld覺.'
              });
              
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                state: 'closed'
              });
            }
