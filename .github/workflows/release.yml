name: CMP Ultra Continuous Evolution

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: 
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  build-and-evolve:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config build-essential \
            libgtk-4-dev libadwaita-1-dev \
            libglib2.0-dev libgirepository1.0-dev \
            libxml2-dev libpango1.0-dev \
            libcairo2-dev libgdk-pixbuf-2.0-dev \
            libgraphene-1.0-dev

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Quality Gate (Linting)
        run: cargo clippy -- -D warnings
        continue-on-error: true

      - name: Build Optimized Binary
        id: cargo_build
        run: |
          # GTK4 derlemesi iÃ§in gerekli path tanÄ±mlamasÄ±
          export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig
          cargo build --release --verbose 2> build_error.log

      - name: AI Fault Analysis & Issue Creation
        if: failure() && steps.cargo_build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let log = "No error log found.";
            if (fs.existsSync('build_error.log')) {
              log = fs.readFileSync('build_error.log', 'utf8').substring(0, 2000);
            }
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: "ðŸš¨ Build Failure: CMP Ultra Auto-Evolution Stalled",
              body: `### Error Diagnostics\n\`\`\`\n${log}\n\`\`\`\n\n**Action:** Please check Cargo.toml dependencies and GTK4 headers.`,
              labels: ['bug', 'critical']
            });

      - name: Prepare Release Assets
        if: success() && github.event_name == 'push'
        run: |
          mkdir -p assets
          # Binary dosyasÄ±nÄ± kopyalayÄ±p isimlendiriyoruz
          cp target/release/clean-master-privacy assets/cmp-ultra-linux-x86_64

      - name: Auto Release
        if: success() && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.${{ github.run_number }}.0
          name: "CMP Ultra Release v1.${{ github.run_number }}"
          body: "ðŸš€ Automated build successful. Performance optimized and security patterns updated."
          files: assets/cmp-ultra-linux-x86_64
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}

  # Pull Request'ler iÃ§in gÃ¼venli otomatik birleÅŸtirme
  automerge:
    needs: build-and-evolve
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Merge PR
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              merge_method: 'squash'
            })
