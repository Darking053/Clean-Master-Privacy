name: Rust Auto-Pilot

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  fix-and-close:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Kodu Ã‡ek
        uses: actions/checkout@v4

      - name: Rust Kurulumu
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      # 1. KODU OTOMATÄ°K DÃœZELT
      - name: HatalarÄ± Temizle (Clippy & Fmt)
        run: |
          cargo fmt --all
          cargo clippy --fix --allow-dirty --allow-staged

      # 2. DEÄÄ°ÅÄ°KLÄ°KLERÄ° PUSHLA
      - name: Otomatik Commit
        id: auto_commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "AI: Kod hatalarÄ± dÃ¼zeltildi ve sistem optimize edildi (Fixes #)"

      # 3. ISSUES'LARI ANALÄ°Z ET VE KAPAT
      - name: SorunlarÄ± Kapat
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            for (const issue of issues.data) {
              // EÄŸer issue etiketlerinde veya baÅŸlÄ±ÄŸÄ±nda 'bug' veya 'fix' geÃ§iyorsa
              if (issue.title.toLowerCase().includes('fix') || issue.labels.some(l => l.name === 'bug')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  body: 'ğŸ¤– Yapay zeka bu sorunu analiz etti, kodu dÃ¼zeltti ve testi geÃ§ti. Sorun kapatÄ±lÄ±yor.'
                });
                
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed'
                });
              }
            }
