name: CMP AI Core Engine

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 1'

jobs:
  static-analysis:
    name: Semantic Code Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Semantik Analiz: Kodun mantıksal hatalarını tarayan derin motor
      - name: Initialize CodeQL Engine
        uses: github/codeql-action/init@v3
        with:
          languages: rust
          queries: security-and-quality

      - name: System Environment Setup
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config build-essential libgtk-4-dev libadwaita-1-dev

      - name: Semantic Build
        run: cargo build --release

      - name: Execute Deep Scan
        uses: github/codeql-action/analyze@v3

  refactor-check:
    name: Auto-Optimization & Fixes
    runs-on: ubuntu-latest
    needs: static-analysis
    steps:
      - name: Checkout Source
        uses: actions/checkout@v4

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      # 2. Hard-Linting: En ufak bir standart dışı kodda hata verir
      - name: Quality Enforcement
        run: |
          cargo fmt --all -- --check
          cargo clippy --all-targets --all-features -- -D warnings

      # 3. Otomatik Bağımlılık Onarımı
      - name: Dependency Hardening
        run: |
          cargo update
          git config --global user.name "CMP-System-Bot"
          git config --global user.email "bot@cmp.internal"
          git add Cargo.lock
          git diff-index --quiet HEAD || (git commit -m "System: Auto-fix dependencies and lockfile" && git push)
